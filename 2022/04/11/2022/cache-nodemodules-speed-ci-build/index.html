<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>通过依赖缓存的方式实现秒级依赖安装加速 CI 构建 - 蔡锦的博客 | Jin&#39;s Blog</title>
<!--<title>通过依赖缓存的方式实现秒级依赖安装加速 CI 构建 - Jin&#39;s Blog</title>-->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-131749872-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-131749872-3');
</script>

<link rel="stylesheet" href="/css/osimple.css">


<link rel="stylesheet" href="/css/theme/theme0.css">

<link rel="shortcut icon" href="/favicon.ico"> 
  
<link rel="stylesheet" href="/css/arduino-light.css">

<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Jin's Blog" type="application/atom+xml">
</head>
<body>
  <div class="header-menu post-header-menu">
    <a class="left" href="/">Jin&#39;s Blog</a>
    <div class="right">
      
        <a href="/">HOME</a>
      
        <a href="/weekly/">WEEKLY</a>
      
        <a href="/archives/">ARCHIVE</a>
      
        <a href="/about/">ABOUT</a>
      
        <a href="/atom.xml">RSS</a>
      
    </div>
  </div>
  <main class="page-container">
    <div class="top-inner">
      <h1 class="page-title">
        通过依赖缓存的方式实现秒级依赖安装加速 CI 构建
      </h1>
      
      <h2 class="page-subtitle">
        Cache node_modules speed CI build
      </h2>
      
      
        <time datetime="2022-04-11T00:00:00.000Z">
<!--            Posted by Jin on -->
          April 11th 2022
        </time>
      
      
        <ul class="tag-list">
          
            <li class="tag-list-item">
              <a href="/tags/CI-CD/">CI/CD</a>
            </li>
          
        </ul>
      
    </div>
    <article class="post">
        <blockquote>
<p>通过手动缓存 node_modules 目录来加速 CI 构建，真滴快（秒级 &lt; 10s）！</p>
</blockquote>
<span id="more"></span>


<p>当我们使用 CI 构建前端项目时，对于一些 NPM 依赖项非常多的项目，依赖安装时间就会特别长。如果我们使用了 monorepo 的模式，整个团队的项目都使用同一个仓库，那么依赖数量就会指数级增长。这个时候进行依赖安装时，通常会需要 10+ 分钟以上的时间，极端情况下可能会达到 30+ 分钟。</p>
<p>这么长的编译时间，则会带来非常多的问题，例如：</p>
<ol>
<li>想部署一下看看效果？先等编译吧您；</li>
<li>测试让你修 bug，你说改好了，但是要等几十分钟编译；</li>
<li>需求要上线了，但是离封板时间剩下几十分钟，结果代码合并到 master 之后，光编译就花了几十分钟，还上锤子线；</li>
<li>…</li>
</ol>
<h2 id="使用-yarn-缓存"><a href="#使用-yarn-缓存" class="headerlink" title="使用 yarn 缓存"></a>使用 yarn 缓存</h2><p>我们可以使用 yarn / npm 的离线模式来安装依赖，这样就可以减少网络请求。但是使用这个缓存是没法减少依赖分析的时间的，所以使用缓存后的安装时间还是比较长。</p>
<h2 id="使用-pnpm"><a href="#使用-pnpm" class="headerlink" title="使用 pnpm"></a>使用 pnpm</h2><p>pnpm 在机制上就比 yarn 和 npm 快很多，可以看一下相关测试：<a target="_blank" rel="noopener" href="https://pnpm.io/benchmarks">https://pnpm.io/benchmarks</a></p>
<img src="/asset/img/2022/cache-nodemodules-speed-ci-build/time.png" alt="time" width="500">

<p>虽然使用 pnpm 能减少构建时间，但是依赖项太多的时候，分析依赖还是需要不少时间，剩下的分析依赖的时间能不能也节省掉呢？答案是可以的。</p>
<h2 id="手动缓存-node-modules"><a href="#手动缓存-node-modules" class="headerlink" title="手动缓存 node_modules"></a>手动缓存 node_modules</h2><p>有没有一种方案可以<strong>实现 10s 内依赖安装完成</strong>？答案是有的，且我们在业务上已经稳定运行两年多了，之前一直想写文章记录一下，一直拖到现在。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>一句话概括：在满足相同条件时，直接使用之前安装的 node_modules，不需要再运行 yarn install，减少依赖安装和索引需要的时间。</p>
<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><ol>
<li>在安装依赖时，先将所有的 package.json 文件进行 hash，获得唯一标识；</li>
<li>在 cache 中寻找是否有对应的 hash cache，如果有，那么就直接使用此 hash cache，将此 cache 软链到我们的项目中就可以完成依赖安装</li>
<li>如果发现没有，那么就算首次安装依赖，这次安装是比较慢的；</li>
<li>将安装完成后的依赖存储到 cache 中，当依赖无变更时，下次安装就可以直接使用 cache；</li>
</ol>
<img src="/asset/img/2022/cache-nodemodules-speed-ci-build/流程图.jpg" width="500px" alt="流程图">

<p>给出的思路是最简单的版本，如果你的项目是 monorepo 则还需要考虑多个 package.json 和每个子项目中的 node_modules，如果项目严格使用 lock 文件的话，其实也可以使用 lock 文件来生成 cache hash 值。</p>
<p>当然这些都是细节上的事情，解决起来都很快，主要是这种缓存的想法。实际代码我就不贴了，因为真的不难。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li>勇神的鬼点子</li>
</ul>

    </article>
    <div class="pager-post">
    
      <a class="prev-link" href="/2022/04/20/2022/performance-optimization-metrics/">
        <span>PREVIOUS</span>
        <p>Web 性能指标定义和获取方法</p>
      </a>
    
    
    
      <a class="next-link" href="/2022/02/27/2022/my-attempt-at-learning-english/">
        <span>NEXT</span>
        <p>英语学习的 N 次失败经历</p>
      </a>
    
  </div>
    
  <div class="post-comment-wrapper">
      <div id="disqus_thread"></div>
<!--      <script src="https://utteranc.es/client.js"-->
<!--              repo="caijinyc/caijinyc.github.io"-->
<!--              issue-term="pathname"-->
<!--              theme="github-light"-->
<!--              crossorigin="anonymous"-->
<!--              async>-->
<!--      </script>-->
  </div>

    <div class="post-all-tags">
      <h1 class="title">ALL TAGS</h1>
      <ul class="all-tag-list">
    
      
      <li class="tag-list-item">
        <a href="/tags/%E7%94%9F%E6%B4%BB/">
          生活
          <span class="count">
            5
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/%E6%80%BB%E7%BB%93/">
          总结
          <span class="count">
            2
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/CI-CD/">
          CI/CD
          <span class="count">
            1
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/%E9%98%85%E8%AF%BB/">
          阅读
          <span class="count">
            1
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/monorepo/">
          monorepo
          <span class="count">
            1
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/%E8%8B%B1%E8%AF%AD/">
          英语
          <span class="count">
            1
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">
          性能优化
          <span class="count">
            1
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/Font/">
          Font
          <span class="count">
            1
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/%E6%B5%8B%E8%AF%95/">
          测试
          <span class="count">
            1
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/%E6%80%9D%E8%80%83/">
          思考
          <span class="count">
            1
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/%E5%B7%A5%E4%BD%9C/">
          工作
          <span class="count">
            1
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/%E6%B8%B8%E6%88%8F/">
          游戏
          <span class="count">
            1
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/CSS/">
          CSS
          <span class="count">
            1
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/JavaScript/">
          JavaScript
          <span class="count">
            8
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">
          数据结构
          <span class="count">
            1
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/Git/">
          Git
          <span class="count">
            1
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/%E5%90%8E%E7%AB%AF/">
          后端
          <span class="count">
            2
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/Vue/">
          Vue
          <span class="count">
            1
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/%E7%A7%BB%E5%8A%A8%E7%AB%AF/">
          移动端
          <span class="count">
            1
          </span>
        </a>
      </li>
      
      <li class="tag-list-item">
        <a href="/tags/Form/">
          Form
          <span class="count">
            1
          </span>
        </a>
      </li>
      
    
  </ul>
    </div>
  </main>
  <footer>
  <div class="connect-inner">
      
        <a href="https://github.com/caijinyc" target="_blank" class="github">
          <i class="iconfont icon-github"></i>
        </a>
      
        <a href="https://juejin.im/user/5acc88a8f265da23a2297002" target="_blank" class="juejin">
          <i class="iconfont icon-juejin"></i>
        </a>
      
        <a href="https://www.zhihu.com/people/adherds/activities" target="_blank" class="zhihu">
          <i class="iconfont icon-zhihu"></i>
        </a>
      
  </div>
  <div class="bottom-inner">
    <p class="theme">Theme <a target="_blank" rel="noopener" href="https://github.com/orbem/hexo-theme-osimple">OSimple</a> by Caijinyc</p>
    <p class="copyright">Copyright © 2022 Jin & Powered by <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></p>
  </div>
</footer>
  
  <script>
      var disqus_shortname = 'orbem';
      var disqus_config = function () {
          <!--this.page.url = 'https://caijin.tech2022/04/11/2022/cache-nodemodules-speed-ci-build/';-->
          // disqus open comment page url
          this.page.url = 'https://caijin.tech/2022/04/11/2022/cache-nodemodules-speed-ci-build/';
          // disqus use this as comment id
          this.page.identifier = '2022/04/11/2022/cache-nodemodules-speed-ci-build/';
      };

      <!--console.log('11', 'https://caijin.tech2022/04/11/2022/cache-nodemodules-speed-ci-build/', 'title,subtitle,date,_content,source,raw,slug,published,updated,comments,layout,photos,link,_id,content,site,excerpt,more,path,permalink,full_source,asset_dir,tags,categories,prev,next,__post,lang,canonical_path', 'https://caijin.tech/2022/04/11/2022/cache-nodemodules-speed-ci-build/')-->

      (function () {
          var d = document, s = d.createElement('script');
          s.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.body || d.head).appendChild(s);
      })();
  </script>

  
<script src="/js/highlight.js"></script>

</body>
</html>


